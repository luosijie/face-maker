{"version":3,"sources":["webpack:///./src/miniprogram/components/menu-background.mpx?43f4","webpack:///./src/miniprogram/components/menu-background.mpx","webpack:///./node_modules/@babel/runtime-corejs3/core-js-stable/instance/find-index.js","webpack:///./node_modules/core-js-pure/stable/instance/find-index.js","webpack:///./node_modules/core-js-pure/es/instance/find-index.js","webpack:///./node_modules/core-js-pure/es/array/virtual/find-index.js","webpack:///./node_modules/core-js-pure/modules/es.array.find-index.js","webpack:///./src/miniprogram/utils/compress.js","webpack:///./src/miniprogram/components/menu-background.mpx?536d","webpack:///./src/miniprogram/components/menu-background.mpx?df11","webpack:///./src/miniprogram/components/menu-background.mpx?49e1","webpack:///./src/miniprogram/utils/checkImage.js"],"names":["image","canvasId","config","maxWidth","maxHeight","_this","resolve","reject","width","height","ratio","canvasCompress","query","createSelectorQuery","select","fields","node","size","exec","res","canvas","ctx","getContext","dpr","wx","getSystemInfoSync","pixelRatio","scale","drawImage","canvasToTempFilePath","x","y","destWidth","destHeight","complete","errMsg","tempFilePath","fail","err","filePath","cloud","uploadFile","cloudPath","Date","getTime","success","callFunction","name","data","fileID","result","showToast","title","icon"],"mappings":"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","file":"components/menu-background0814934a/menu-background.js","sourcesContent":["global.currentModuleId\n/* script */\nexport * from \"!!babel-loader!../../../node_modules/@mpxjs/webpack-plugin/lib/selector?type=script&index=0!./menu-background.mpx\"\n\n/* styles */\nrequire(\"!!../../../node_modules/@mpxjs/webpack-plugin/lib/extractor?type=styles&index=0!../../../node_modules/@mpxjs/webpack-plugin/lib/wxss/loader?sourceMap&root=&importLoaders=1&extract=true!../../../node_modules/@mpxjs/webpack-plugin/lib/style-compiler/index?{\\\"moduleId\\\":\\\"m6182d117\\\",\\\"scoped\\\":false,\\\"sourceMap\\\":true}!stylus-loader!../../../node_modules/@mpxjs/webpack-plugin/lib/selector?type=styles&index=0!./menu-background.mpx\")\n\n/* json */\nrequire(\"!!../../../node_modules/@mpxjs/webpack-plugin/lib/extractor?type=json&index=0!../../../node_modules/@mpxjs/webpack-plugin/lib/json-compiler/index?root=!../../../node_modules/@mpxjs/webpack-plugin/lib/selector?type=json&index=0!./menu-background.mpx\")\n\n/* template */\nrequire(\"!!../../../node_modules/@mpxjs/webpack-plugin/lib/extractor?type=template&index=0!../../../node_modules/@mpxjs/webpack-plugin/lib/wxml/wxml-loader?root=!../../../node_modules/@mpxjs/webpack-plugin/lib/template-compiler/index?{\\\"usingComponents\\\":[],\\\"hasScoped\\\":false,\\\"isNative\\\":false,\\\"moduleId\\\":\\\"m6182d117\\\",\\\"projectRoot\\\":\\\"\\\"}!../../../node_modules/@mpxjs/webpack-plugin/lib/selector?type=template&index=0!./menu-background.mpx\")\n\n","<template>\n  <view class=\"menu-background\">\n    <view class=\"item replace\" bindtap=\"chooseImage\">\n      <i class=\"iconfont icon-image\"></i>\n      <text class=\"title\">图片</text>\n      <text class=\"sub-title\">图片仅供本地使用</text>\n    </view>\n    <canvas\n      type=\"2d\"\n      id=\"canvas_compress\"\n      class=\"canvas-compress\"\n      style=\"width: {{canvasCompress.width}}px; height: {{canvasCompress.height}}px\"\n    />\n  </view>\n</template>\n\n<script>\nimport { createComponent } from '@mpxjs/core'\nimport store from '../store'\nimport loadImage from '../utils/loadImage'\nimport compress from '../utils/compress'\nimport checkImage from '../utils/checkImage'\n\ncreateComponent({\n  data: {\n    canvasCompress: {\n      width: 0,\n      height: 0\n    }\n  },\n  computed: {\n    canvas() {\n      return store.state.canvas\n    },\n    ctx() {\n      return store.state.ctx\n    },\n    elements() {\n      return store.state.elements\n    },\n    dpr() {\n      return wx.getSystemInfoSync().pixelRatio\n    }\n  },\n  methods: {\n    chooseImage() {\n      wx.chooseImage({\n        count: 1,\n        sizeType: ['original', 'compressed'],\n        sourceType: ['album', 'camera'],\n        success: async res => {\n          if (res.errMsg === 'chooseImage:ok') {\n            wx.showLoading({ title: '图片加载中' })\n            const path = res.tempFilePaths[0]\n            const image = await loadImage(path, this.canvas)\n            const filePath = await compress.call(this, image, 'canvas_compress')\n            const imgValid = await checkImage(filePath)\n            wx.hideLoading()\n            if (!imgValid) return\n            // 图片安全检测通过，执行图片插入操作\n            const cWidth = this.canvas.width / this.dpr\n            const cHeight = this.canvas.height / this.dpr\n            const data = {\n              type: 'background',\n              data: image,\n              left: 0,\n              top: 0,\n              width: 0,\n              height: 0,\n              scale: 1,\n              rotate: 0\n            }\n            if (image.height > image.width) {\n              // 图片高大于宽\n              const rate = image.height / cHeight\n              data.width = image.width / rate\n              data.height = cHeight\n              data.left = (cWidth - data.width) / 2\n              data.top = 0\n            } else {\n              // 图片宽大于高\n              const rate = image.width / cWidth\n              data.height = image.height / rate\n              data.width = cWidth\n              data.left = 0\n              data.top = (cHeight - data.height) / 2\n            }\n            const index = this.elements.findIndex(e => e.type === 'background')\n            if (index > -1) {\n              this.elements.splice(index, 1, data)\n            } else {\n              this.elements.unshift(data)\n            }\n          }\n        }\n      })\n    }\n  },\n  ready() {\n    // this.initCanvas()\n  }\n})\n</script>\n\n<style lang=\"stylus\">\n@import url('../assets/iconfont/iconfont.css')\n\n.menu-background\n  display flex\n  justify-content center\n  align-items center\n  height 100%\n  position relative\n  padding 20rpx\n  .item\n    color #666\n    font-size 28rpx\n    margin 10rpx\n  .replace\n    display flex\n    flex-direction column\n    align-items center\n    color #999\n    i\n      font-size 80rpx\n    text.title\n      font-size 24rpx\n      font-weight bold\n    text.sub-title\n      margin-top 20rpx\n      font-size 20rpx\n  .canvas-compress\n    position absolute\n    left 0\n    top 1000px\n    z-index -999\n</style>\n\n<script type=\"application/json\">\n  {\n    \"component\": true\n  }\n</script>\n","module.exports = require(\"core-js-pure/stable/instance/find-index\");","var parent = require('../../es/instance/find-index');\n\nmodule.exports = parent;\n","var findIndex = require('../array/virtual/find-index');\n\nvar ArrayPrototype = Array.prototype;\n\nmodule.exports = function (it) {\n  var own = it.findIndex;\n  return it === ArrayPrototype || (it instanceof Array && own === ArrayPrototype.findIndex) ? findIndex : own;\n};\n","require('../../../modules/es.array.find-index');\nvar entryVirtual = require('../../../internals/entry-virtual');\n\nmodule.exports = entryVirtual('Array').findIndex;\n","'use strict';\nvar $ = require('../internals/export');\nvar $findIndex = require('../internals/array-iteration').findIndex;\nvar addToUnscopables = require('../internals/add-to-unscopables');\nvar arrayMethodUsesToLength = require('../internals/array-method-uses-to-length');\n\nvar FIND_INDEX = 'findIndex';\nvar SKIPS_HOLES = true;\n\nvar USES_TO_LENGTH = arrayMethodUsesToLength(FIND_INDEX);\n\n// Shouldn't skip holes\nif (FIND_INDEX in []) Array(1)[FIND_INDEX](function () { SKIPS_HOLES = false; });\n\n// `Array.prototype.findIndex` method\n// https://tc39.github.io/ecma262/#sec-array.prototype.findindex\n$({ target: 'Array', proto: true, forced: SKIPS_HOLES || !USES_TO_LENGTH }, {\n  findIndex: function findIndex(callbackfn /* , that = undefined */) {\n    return $findIndex(this, callbackfn, arguments.length > 1 ? arguments[1] : undefined);\n  }\n});\n\n// https://tc39.github.io/ecma262/#sec-array.prototype-@@unscopables\naddToUnscopables(FIND_INDEX);\n","/**\n * 压缩图片\n * 将尺寸超过规范的图片最小限度压缩\n * @param {Image} image 需要压缩的图片实例\n * @param {String} canvasId 用来处理压缩图片的canvas对应的canvasId\n * @param {Object} config 压缩的图片规范 -> { maxWidth 最大宽度, maxHeight 最小宽度 }\n * @return {Promise} promise返回 压缩后的 图片路径\n */\nexport default function (image, canvasId, config = { maxWidth: 750, maxHeight: 1334 }) {\n  // 引用的组件传入的this作用域\n  const _this = this\n  return new Promise((resolve, reject) => {\n    // 获取图片原始宽高\n    let width = image.width\n    let height = image.height\n    // 宽度 > 最大限宽 -> 重置尺寸\n    if (width > config.maxWidth) {\n      const ratio = width / config.maxWidth\n      width = config.maxWidth\n      height = height / ratio\n    }\n    // 高度 > 最大限高度 -> 重置尺寸\n    if (height > config.maxHeight) {\n      const ratio = height / config.maxHeight\n      height = config.maxHeight\n      width = width / ratio\n    }\n    // 设置canvas的css宽高\n    _this.canvasCompress.width = width\n    _this.canvasCompress.height = height\n    const query = this.createSelectorQuery()\n    query\n      .select(`#${canvasId}`)\n      .fields({ node: true, size: true })\n      .exec(async res => {\n        // 获取 canvas 实例\n        const canvas = res[0].node\n        // 获取 canvas 绘图上下文\n        const ctx = canvas.getContext('2d')\n        // 根据设备dpr处理尺寸\n        const dpr = wx.getSystemInfoSync().pixelRatio\n        canvas.width = width * dpr\n        canvas.height = height * dpr\n        ctx.scale(dpr, dpr)\n        // 将图片绘制到 canvas\n        ctx.drawImage(image, 0, 0, width, height)\n        // 将canvas图片上传到微信临时文件\n        wx.canvasToTempFilePath({\n          canvas,\n          x: 0,\n          y: 0,\n          destWidth: width,\n          destHeight: height,\n          complete (res) {\n            if (res.errMsg === 'canvasToTempFilePath:ok') {\n              // 返回临时文件路径\n              resolve(res.tempFilePath)\n            }\n          },\n          fail(err) {\n            reject(err)\n          }\n        })\n      })\n  })\n}\n","// removed by extractor","// removed by extractor","// removed by extractor","/**\n * 校验图片是否存在敏感信息\n * @param { String } filePath\n * @return { Promise } \b\bpromise返回校验结果\n */\nexport default function (filePath) {\n  return new Promise((resolve, reject) => {\n    // 先将图片上传到云开发存储\n    wx.cloud.uploadFile({\n      cloudPath: `${new Date().getTime()}.png`,\n      filePath,\n      success (res) {\n        // 调用云函数-checkImage\n        wx.cloud.callFunction({\n          name: 'checkImage',\n          data: {\n            fileID: res.fileID\n          },\n          success (res) {\n            // res.result -> 0:存在敏感信息；1:校验通过\n            resolve(res.result)\n            if (!res.result) {\n              wx.showToast({\n                title: '图片可能含有敏感信息, 请重新选择',\n                icon: 'none'\n              })\n            }\n          },\n          fail (err) {\n            reject(err)\n          }\n        })\n      },\n      fail (err) {\n        reject(err)\n      }\n    })\n  })\n}\n"],"sourceRoot":""}